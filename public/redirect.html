<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OIDC Redirect Handler</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: hsl(222, 84%, 4.9%);
            color: hsl(213, 31%, 91%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: hsl(224, 71%, 4%);
            border-radius: 0.5rem;
            border: 1px solid hsl(215, 27.9%, 16.9%);
        }
        .loading {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .success {
            color: hsl(142, 76%, 36%);
        }
        .error {
            color: hsl(0, 63%, 31%);
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="status">
            <div class="loading">⟳</div>
            <p>Processing authentication response...</p>
        </div>
    </div>

    <script>
        (function() {
            try {
                // Parse URL parameters and hash fragments
                const urlParams = new URLSearchParams(window.location.search);
                const hashParams = new URLSearchParams(window.location.hash.substring(1));
                
                // Combine both parameter sources
                const allParams = {};
                for (const [key, value] of urlParams) {
                    allParams[key] = value;
                }
                for (const [key, value] of hashParams) {
                    allParams[key] = value;
                }

                // Validate state parameter (REQUIRED for CSRF protection per RFC 9700)
                const storedState = sessionStorage.getItem('oidc_state');
                if (!storedState) {
                    throw new Error('No stored state found - session may have expired');
                }
                if (!allParams.state) {
                    throw new Error('No state parameter in response - possible attack');
                }
                if (allParams.state !== storedState) {
                    throw new Error('State parameter mismatch - possible CSRF attack');
                }

                // Update status
                const statusEl = document.getElementById('status');
                
                if (allParams.error) {
                    statusEl.innerHTML = `
                        <div class="error">✗</div>
                        <p>Authentication failed: ${allParams.error}</p>
                        ${allParams.error_description ? `<p>${allParams.error_description}</p>` : ''}
                    `;
                } else if (allParams.code || allParams.access_token || allParams.id_token) {
                    statusEl.innerHTML = `
                        <div class="success">✓</div>
                        <p>Authentication successful! Closing window...</p>
                    `;
                } else {
                    throw new Error('No authorization code or tokens received');
                }

                // Send message to parent window
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'OIDC_CALLBACK',
                        data: allParams
                    }, window.location.origin);

                    // Close window after a short delay
                    setTimeout(() => {
                        window.close();
                    }, 1500);
                } else {
                    statusEl.innerHTML = `
                        <div class="error">✗</div>
                        <p>Unable to communicate with parent window</p>
                        <p>Please manually close this window and check the main application</p>
                    `;
                }

            } catch (error) {
                console.error('Redirect handler error:', error);
                
                const statusEl = document.getElementById('status');
                statusEl.innerHTML = `
                    <div class="error">✗</div>
                    <p>Error processing authentication response</p>
                    <p>${error.message}</p>
                `;

                // Still try to send error to parent
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'OIDC_CALLBACK',
                        data: {
                            error: 'redirect_handler_error',
                            error_description: error.message
                        }
                    }, window.location.origin);
                }
            }
        })();
    </script>
</body>
</html>